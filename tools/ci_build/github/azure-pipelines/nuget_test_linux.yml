jobs:
- job: NuGet_Test_Linux
  pool: Linux-CPU
  dependsOn:
  - NuGet_Packaging
  condition: succeeded()
  variables:
    OnnxRuntimeBuildDirectory: '$(Build.BinariesDirectory)'
  steps:
  - task: CmdLine@2
    displayName: 'Download azcopy'
    inputs:
      script: |
        curl -so azcopy.tar.gz -L 'https://aka.ms/downloadazcopy-v10-linux'
        tar -zxvf azcopy.tar.gz --strip 1
      workingDirectory: $(Build.BinariesDirectory)

  - task: PythonScript@0
    displayName: 'Download test data'
    inputs:
      scriptPath: '$(Build.SourcesDirectory)/tools/ci_build/github/download_test_data.py'
      arguments: --test_data_url $(TestDataUrl)
      pythonInterpreter: '/usr/bin/python3'
      workingDirectory: $(Build.BinariesDirectory)

  - task: DownloadPipelineArtifact@0
    displayName: 'Download Signed NuGet'
    inputs:
      artifactName: 'drop-signed-nuget'
      targetPath: '$(Build.BinariesDirectory)/nuget-artifact'

  - script: |
     set -e -x
     $(Build.SourcesDirectory)/csharp/test/Microsoft.ML.OnnxRuntime.EndToEndTests/runtest-docker.sh $(Build.SourcesDirectory) $(Build.BinariesDirectory) nuget-artifact
    displayName: 'Run Package Test (x64)'
    env:
      OnnxRuntimeBuildDirectory: $(Build.BinariesDirectory)

  - task: mspremier.PostBuildCleanup.PostBuildCleanup-task.PostBuildCleanup@3
    displayName: 'Clean Agent Directories'
    condition: always()
